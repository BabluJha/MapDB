
<!DOCTYPE html>
<!--
 Generated by Apache Maven Doxia at Jun 27, 2013
 Rendered using Maven Reflow Skin 1.0.0 (http://andriusvelykis.github.com/reflow-maven-skin)
-->
<html  xml:lang="en" lang="en">

	<head>
		<meta charset="UTF-8" />
		<title>Store Format | mapdb</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<meta name="description" content="" />
		<meta http-equiv="content-language" content="en" />

		<link href="http://netdna.bootstrapcdn.com/bootswatch/2.2.2/cerulean/bootstrap.min.css" rel="stylesheet" />
		<link href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.2/css/bootstrap-responsive.min.css" rel="stylesheet" />
		<link href="./css/bootswatch.css" rel="stylesheet" />
		<link href="./css/reflow-skin.css" rel="stylesheet" />
		
		<link href="http://yandex.st/highlightjs/7.3/styles/github.min.css" rel="stylesheet" />
		
		<link href="./css/lightbox.css" rel="stylesheet" />
		
		<link href="./css/site.css" rel="stylesheet" />
		<link href="./css/print.css" rel="stylesheet" media="print" />
		
		<!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
		<!--[if lt IE 9]>
			<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
		<![endif]-->
		
<script src="js/jquery.min.js"></script>
<script src="js/excanvas.js"></script>
<script src="js/js-class.js"></script>
<script src="js/bluff.js"></script>
	</head>

	<body class="page-store-format project-mapdb" data-spy="scroll" data-offset="60" data-target="#toc-scroll-target">

		<div class="navbar navbar-fixed-top">
			<div class="navbar-inner">
				<div class="container">
					<a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
					</a>
					<a class="brand" href="./"><img src="images/logo.png" border="0" alt="MapDB"/>
                <div style="font-size:12px">Java beyond heap</div></a>
					<div class="nav-collapse">
						<ul class="nav pull-right">
							<li class="dropdown">
								<a href="#" class="dropdown-toggle" data-toggle="dropdown">MapDB <b class="caret"></b></a>
								<ul class="dropdown-menu">
									<li><a href="index.html" title="Index">Index </a></li>
									<li><a href="http://www.github.com/jankotek/mapdb" title="Github" class="externalLink">Github </a></li>
									<li><a href="features.html" title="Features">Features </a></li>
									<li><a href="faq.html" title="Frequently Asked Questions">Frequently Asked Questions </a></li>
									<li><a href="credits.html" title="Credits">Credits </a></li>
								</ul>
							</li>
							<li class="dropdown">
								<a href="#" class="dropdown-toggle" data-toggle="dropdown">Documentation <b class="caret"></b></a>
								<ul class="dropdown-menu">
									<li><a href="intro.html" title="Intro">Intro </a></li>
									<li><a href="http://www.youtube.com/watch?v=FdZmyEHcWLI" title="Overview Video" class="externalLink">Overview Video </a></li>
									<li><a href="https://github.com/jankotek/MapDB/tree/master/src/test/java/examples" title="Examples" class="externalLink">Examples </a></li>
									<li><a href="apidocs/index.html" title="JavaDoc">JavaDoc </a></li>
								</ul>
							</li>
							<li class="dropdown">
								<a href="#" class="dropdown-toggle" data-toggle="dropdown">Support <b class="caret"></b></a>
								<ul class="dropdown-menu">
									<li><a href="http://groups.google.com/group/mapdb" title="Mail list" class="externalLink">Mail list </a></li>
									<li><a href="https://github.com/jankotek/MapDB/issues" title="Bug tracker" class="externalLink">Bug tracker </a></li>
								</ul>
							</li>
						</ul>
					</div><!--/.nav-collapse -->
				</div>
			</div>
		</div>
		
	<div class="container">
	
	<!-- Masthead
	================================================== -->
	</header>

	<div class="main-body">
	<div class="row">
		<div class="span8">
			<div class="body-content">
<div class="page-header">
 <h1 id="store_format">Store Format</h1>
</div> 
<p>JDBM4 storage has two different areas: the index and data files. The index file is a list of 8-byte-long addresses pointing into the data file. The data file contains raw record data.</p> 
<p>Store internal information, such as the list of free records, is maintained using long stacks. It is a reverse linked list of 8-byte-longs storing addresses. It is stored in a data file, as any other records.</p> 
<p>JDBM4 store is very minimalistic with little redundancy. Its design is focused on maximum speed and minimum overhead. A lot of operations (transaction, locking) are done in memory.</p> 
<div class="section"> 
 <h2 id="Index_File">Index File</h2> 
 <p>The index file is a list of 8-byte-long addresses pointing to the data file. Each address is identified by its position in the index file. When <tt>RecordManager</tt> returns <tt>recid</tt> it actually returns a location in the index file.</p> 
 <p>Each address is 8-byte-long, so the index file offset is calculated by multiplying recid with eight:</p> 
 <div class="source"> 
  <pre>index-file-offset = recid * 8
</pre> 
 </div> 
 <p>Some starting index positions are reserved for internal use. Those still contain 8-byte-long addresses, but point to internal data, such as the list of free records. <tt>Recid</tt> returned by <tt>RecordManager</tt> will be always greater than 2555.</p> 
 <div class="source"> 
  <pre>0  - file header and store format version 'JDBMXXXX'..
1 - current size of data file (pointer to end of data file)
2  - data address of 'long stack' containing free positions in the index file
3 to 18 - reserved addresses for JDBM internal objects, such as Serializer or Name Table.
19 - unreserved address (feel free to use it for your own stuff)
 20 to 2555 - data addresses of free data records (see next chapters)
 2556 to infinity - contains recids of user records.
</pre> 
 </div> 
 <p>8-byte-long addresses stored in the index file have two parts: The first 2 bytes is the data record size and the last 6 bytes are the offset in the data file. JDBM store currently supports a record of maximum size 64KB (2^16), some workaround for bigger records will come in the future. And the entire store has maximum size 256 TeraBytes (2^48).</p> 
 <p>Some addresses in the index file may have 0 value. This indicates that the record with the given recid has been deleted, or not yet claimed.</p> 
</div> 
<div class="section"> 
 <h2 id="Data_File">Data File</h2> 
 <p>The data file has no structure, it just contains records followed by other records. There are no metadata, checksums or separators. All structural information is stored in the index file.</p> 
 <p>The first 8 bytes of the data file are reserved for the file header and store format version in format JDBMXXXX. This is to prevent zero from being a valid address.</p> 
</div> 
<div class="section"> 
 <h2 id="Long_Stack">Long Stack</h2> 
 <p>Long Stack is reverse linked list of 8-byte-longs implemented on top of the record store. JDBM uses it to store its internal information such as a list of free records. It supports only two operations (<tt>pop</tt> and <tt>take</tt>), which add and remove a number from the head of the list. Numbers are inserted and removed in LIFO (Last In, First Out) fashion.</p> 
 <p>It is very low-level and tightly integrated into RecordManager, to minimise the number of IO operations. Each operation typically requires only 9 bytes to be read and written. It also takes nearly constant time and is not affected by store fragmentation</p> 
 <p>Each Long Stack has:</p> 
 <p><b>Long Stack Recid</b> in Index File which contains address to Head Record. Each Long Stack is identified by this recid.</p> 
 <p><b>Head Record</b> containing most recently inserted numbers. It is located in the Data File. It is referenced from the Index File.</p> 
 <p><b>Previous Records</b> contains previously inserted numbers. It is located in the Data File and is basically a Linked List of records starting at Head Record.</p> 
 <p>Numbers are grouped into records, each containing 100 numbers. Records are chained, as the reverse-linked list starting at Head Record.</p> 
 <p>When a number is inserted into the record and it overflows 100, a new Head Record is created. This new Head Record contains the address to the Previous Record. Also the address in the Index File is updated to point to the new Head Record.</p> 
 <p>Each Long Stack Record has the following structure:</p> 
 <div class="source"> 
  <pre>byte 0 - how many numbers are inserted in this record
byte 1 - unused
byte   2 to  7 - offset of Previous Record in the Data File
byte  7 to  15 - first number on this record
byte 16 to 23 - second number on this record....
</pre> 
 </div> 
</div> 
<div class="section"> 
 <h2 id="Free_positions_in_Index_File">Free positions in Index File</h2> 
 <p>When a record is deleted, the <tt>RecordManager</tt> sets the given position in the Data File to zero. Recently released recid are stored in Long Stack with recid 2 for reuse.</p> 
</div> 
<div class="section"> 
 <h2 id="List_of_free_data_records">List of free data records</h2> 
 <p>The List of free data records is stored in multiple Long Stacks determined by the record size. When a data record with size N is released, it is added to Long Stack N. When a data record is allocated, it has to look at Long Stack N, if it contains any free record to use. It does not have to make a linear scan across the list of all free data records.</p> 
 <p>TODO describe this more.</p> 
</div> 
<div class="section"> 
 <h2 id="Defrag">Defrag</h2> 
 <p>Defragmentation recreates store in new file. It traverse Index File, reads addresses and insert data records into new RecordManager. New file is then moved over the old file.</p> 
</div>
			</div>
		</div>
		<div class="span4">
			<div id="toc-sidebar">
				<div class="well">
					<ul class="nav nav-list">
						<li class="nav-header">Table of Contents</li>
		<li class="dropdown"><a href="#store_format" title="Store Format">Store Format <b class="caret"></b></a>
			<ul class="nav nav-list">
		<li><a href="#Index_File" title="Index File">Index File</a>
		<li><a href="#Data_File" title="Data File">Data File</a>
		<li><a href="#Long_Stack" title="Long Stack">Long Stack</a>
		<li><a href="#Free_positions_in_Index_File" title="Free positions in Index File">Free positions in Index File</a>
		<li><a href="#List_of_free_data_records" title="List of free data records">List of free data records</a>
		<li><a href="#Defrag" title="Defrag">Defrag</a>
				<li class="divider"></li>
			</ul>
		</li>
					</ul>
				</div>
			</div>
		</div>
	</div>
	</div>

	</div><!-- /container -->
	
	<!-- Footer
	================================================== -->
	<footer class="well">
		<div class="container">
			<div class="row">
				<div class="span2 bottom-nav">
					<ul class="nav nav-list">
						<li class="nav-header">MapDB</li>
						<li>
							<a href="index.html" title="Index">Index </a>
						</li>
						<li>
							<a href="http://www.github.com/jankotek/mapdb" title="Github" class="externalLink">Github </a>
						</li>
						<li>
							<a href="features.html" title="Features">Features </a>
						</li>
						<li>
							<a href="faq.html" title="Frequently Asked Questions">Frequently Asked Questions </a>
						</li>
						<li>
							<a href="credits.html" title="Credits">Credits </a>
						</li>
					</ul>
				</div>
				<div class="span2 bottom-nav">
					<ul class="nav nav-list">
						<li class="nav-header">Documentation</li>
						<li>
							<a href="intro.html" title="Intro">Intro </a>
						</li>
						<li>
							<a href="http://www.youtube.com/watch?v=FdZmyEHcWLI" title="Overview Video" class="externalLink">Overview Video </a>
						</li>
						<li>
							<a href="https://github.com/jankotek/MapDB/tree/master/src/test/java/examples" title="Examples" class="externalLink">Examples </a>
						</li>
						<li>
							<a href="apidocs/index.html" title="JavaDoc">JavaDoc </a>
						</li>
					</ul>
				</div>
				<div class="span2 bottom-nav">
					<ul class="nav nav-list">
						<li class="nav-header">Support</li>
						<li>
							<a href="http://groups.google.com/group/mapdb" title="Mail list" class="externalLink">Mail list </a>
						</li>
						<li>
							<a href="https://github.com/jankotek/MapDB/issues" title="Bug tracker" class="externalLink">Bug tracker </a>
						</li>
					</ul>
				</div>
				<div class="span3 bottom-nav">
					<ul class="nav nav-list">
						<li class="nav-header">Author</li>
						<li>
							<a href="http://www.kotek.net/" title="Blog" class="externalLink">Blog </a>
						</li>
						<li>
							<a href="http://www.twitter.com/jankotek" title="Twitter" class="externalLink">Twitter </a>
						</li>
						<li>
							<a href="mailto:jan@kotek.net" title="Email" class="externalLink">Email </a>
						</li>
						<li>
							<a href="http://www.kotek.net" title="About" class="externalLink">About </a>
						</li>
					</ul>
				</div>
				<div class="span3 bottom-description">
					<blockquote>MapDB is free as a beer under Apache license. Please support us to make sure it remains free.
                <a href="https://www.paypal.com/cgi-bin/webscr?cmd=_donations&business=JAGF7RKHMPNHA&lc=IE&currency_code=EUR&bn=PP%2dDonationsBF%3abtn_donate_LG%2egif%3aNonHosted">
                <img src="images/donate.gif" alt="Donate"/>
                </a></blockquote>
				</div>
			</div>
		</div>
	</footer>
		
	<div class="container subfooter">
		<div class="row">
			<div class="span12">
				<p class="pull-right"><a href="#">Back to top</a></p>
				<p class="copyright">Copyright &copy;2013. All Rights Reserved.</p>
				<p class="version-date"><span class="projectVersion">Version: 0.9.4-SNAPSHOT. </span><span class="publishDate">Last Published: 2013-06-27. </span></p>
				<p><a href="http://github.com/andriusvelykis/reflow-maven-skin" title="Reflow Maven skin">Reflow Maven skin</a> by <a href="http://andrius.velykis.lt" target="_blank" title="Andrius Velykis">Andrius Velykis</a>.</p>
			</div>
		</div>
	</div>

	<!-- Le javascript
	================================================== -->
	<!-- Placed at the end of the document so the pages load faster -->

	<!-- Fallback jQuery loading from Google CDN:
	     http://stackoverflow.com/questions/1014203/best-way-to-use-googles-hosted-jquery-but-fall-back-to-my-hosted-library-on-go -->
	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
	<script type="text/javascript">
		if (typeof jQuery == 'undefined')
		{
			document.write(unescape("%3Cscript src='./js/jquery-1.8.3.min.js' type='text/javascript'%3E%3C/script%3E"));
		}
	</script>
	
	<script src="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.2/js/bootstrap.min.js"></script>
	<script src="./js/lightbox.js"></script>
	<script src="./js/jquery.smooth-scroll.min.js"></script>
	<!-- back button support for smooth scroll -->
	<script src="./js/jquery.ba-bbq.min.js"></script>
	<script src="http://yandex.st/highlightjs/7.3/highlight.min.js"></script>

	<script src="./js/reflow-skin.js"></script>
	
	</body>
</html>
